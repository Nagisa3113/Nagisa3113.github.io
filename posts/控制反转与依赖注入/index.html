<!DOCTYPE html>
<html lang="en-us">
  <head>
    <title>控制反转与依赖注入 | Nostalgia</title>

    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">    
<meta name="viewport" content="width=device-width,minimum-scale=1">
<meta name="description" content="控制反转(Inversion of Control，IoC），是面向对象编程中的一种设计原则，可以用来减低计算机代码之间的耦合度。常用于Web开发,如Spring MVC。
它把传统上由程序代码直接操控的对象的调用权交给容器，通过容器来实现对象组件的装配和管理。所谓的“控制反转”概念就是对组件对象控制权的转移，从程序代码本身转移到了外部容器。
通过控制反转，对象在被创建的时候，由一个调控系统内所有对象的外界实体(容器)。">
<meta name="generator" content="Hugo 0.110.0">


  <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">


<link rel="stylesheet" href="/css/style.css">



<link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon" />

 
    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'your-google-analytics-id', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>




  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.css" integrity="sha384-RZU/ijkSsFbcmivfdRBQDtwuwVqK7GMOw6IMvKyeWL2K5UAlyp6WonmB8m7Jd0Hn" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.js" integrity="sha384-pK1WpvzWVBQiP0/GjnvRxV4mOb0oxFuyRxJlk6vVw146n3egcN5C925NCP7a7BY8" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/contrib/auto-render.min.js" integrity="sha384-vZTG03m+2yp6N6BNi5iM4rW4oIwk5DfcNdFfxkk9ZWpDriOkXX8voJBFrAO7MpVl" crossorigin="anonymous"
    onload="renderMathInElement(document.body);"></script>




  </head>

  <body>
    <nav class="navigation">
	
		<a href="/"> <span class="arrow">←</span>Home</a>
	
	<a href="/posts">Archive</a>
	<a href="/tags">Tags</a>
	<a href="/about">About</a>

	

	
</nav>


    <main class="main">
      

<section id="single">
    <h1 class="title">控制反转与依赖注入</h1>

    <div class="tip">
        <time datetime="2019-05-25 00:00:00 &#43;0000 UTC">May 25, 2019</time>
        <span class="split">
          ·
        </span>
        <span>
          1255 words
        </span>
        <span class="split">
          ·
        </span>
        <span>
          3 minute read
        </span>
    </div>

    
    
        
  
    <aside class="toc">
      <details>
          <summary>Table of Contents
          </summary>
          <div>
              <nav id="TableOfContents">
  <ul>
    <li><a href="#strangeioc">StrangeIoC</a></li>
  </ul>
</nav>
          </div>
      </details>
    </aside>
  


    


    <div class="content">
      <p>控制反转(Inversion of Control，IoC），是面向对象编程中的一种设计原则，可以用来减低计算机代码之间的耦合度。常用于Web开发,如Spring MVC。</p>
<p>它把传统上由程序代码直接操控的对象的调用权交给容器，通过容器来实现对象组件的装配和管理。所谓的“控制反转”概念就是对组件对象控制权的转移，从程序代码本身转移到了外部容器。</p>
<p>通过控制反转，对象在被创建的时候，由一个调控系统内所有对象的外界实体(容器)。</p>
<p>举个例子，我们创建了一个英雄(Hero)，他的组件有武器和铠甲，我们如何去获得一个武器呢,</p>
<ul>
<li>传统方式: 在英雄脚本中 new 一个 Weapon 出来 ,该对象的创建、销毁、生命周期都由Hero控制,Hero依赖Weapon,耦合度高</li>
<li>IOC: 容器先创建好Weapon,当Hero需要时,从该容器中取出要用的Weapon交给Hero使用,至于容器怎么创建Weapon的,Hero不需要关心</li>
</ul>
<p>IoC主要实现方式有两种：</p>
<ol>
<li>
<p>依赖查找(Dependency Lookup）：容器提供回调接口和上下文环境给组件。</p>
<p>例如Unity中 GameObject.Find(Name)</p>
</li>
<li>
<p>依赖注入(Dependency Injection）：组件不做定位查询，只提供普通的方法让容器去决定依赖关系。</p>
</li>
</ol>
<p>其又有三种方式,拿之前Hero的例子来说:</p>
<ol>
<li>接口注入(Interface Injection): 让英雄继承SetObject()接口,在英雄中实现SetObject(Weapon)方法</li>
<li>设值注入(Setter Injection): 在类中写一个方法,SetWeapon(content),让外部容器传调用传入依赖</li>
<li>构造子注入(Constructor Injection): 在英雄的构造函数中写方法,Hero(content),在建立对象时传入依赖.</li>
</ol>
<h2 id="strangeioc">StrangeIoC <a href="#strangeioc" class="anchor">🔗</a></h2><p>StraneIoC是一个轻量、高扩展性的Unity,C#的IoC框架,其使用的方式为依赖注入.</p>
<p><a href="https://strangeioc.github.io/strangeioc/" target="_blank" rel="noopener">StrangeIoC官网</a>一张图可以概括,我们先继续往下看 <p class="markdown-image">
  <img src="https://strangeioc.github.io/strangeioc/class-flow.png" alt="img"  />
</p></p>
<p>官方给出的例子: 假如我在玩一个游戏,每次结束时如果获得了更高的分数,想要将最高分上传到Facebook,在传统Unity方式下,会是这样的</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c#" data-lang="c#"><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">public</span> <span style="color:#a2f;font-weight:bold">class</span> <span style="color:#00f">MyShip</span> : MonoBehaviour {    
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">private</span> FacebookService facebook;    
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">private</span> <span style="color:#0b0;font-weight:bold">int</span> myScore;     
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">void</span> Awake(){    	
</span></span><span style="display:flex;"><span>        facebook = FacebookService.getInstance();    
</span></span><span style="display:flex;"><span>    }     
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">void</span> onDie(){    	
</span></span><span style="display:flex;"><span>        <span style="color:#a2f;font-weight:bold">if</span> (score &gt; highScore)	
</span></span><span style="display:flex;"><span>            facebook.PostScore(myScore);    
</span></span><span style="display:flex;"><span>    } 
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>这样写会导致游戏本身逻辑和服务器紧密相连;如果我们将facebook替换成Twitter或Google+，会变得麻烦</p>
<p>但在IOC中，我们移除了逻辑部分，只需要发出一个信息(事件)–“游戏结束了”，让Command单元去处理该事件</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c#" data-lang="c#"><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">public</span> <span style="color:#a2f;font-weight:bold">class</span> <span style="color:#00f">MyShip</span> : MonoBehaviour {   
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">void</span> onDie(){      
</span></span><span style="display:flex;"><span>        dispatcher.Dispatch(GameEvent.SHIP_DEAD);   
</span></span><span style="display:flex;"><span>    } 
</span></span><span style="display:flex;"><span>} 
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c#" data-lang="c#"><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">public</span> <span style="color:#a2f;font-weight:bold">class</span> <span style="color:#00f">OnShipDeathCommand</span> : EventCommand {   
</span></span><span style="display:flex;"><span><span style="color:#b44">    [Inject]</span>   
</span></span><span style="display:flex;"><span>    ISocialService socialService{<span style="color:#a2f;font-weight:bold">get</span>; <span style="color:#a2f;font-weight:bold">set</span>;}      
</span></span><span style="display:flex;"><span><span style="color:#b44">    [Inject]</span>   
</span></span><span style="display:flex;"><span>    IScoreModel scoreModel{<span style="color:#a2f;font-weight:bold">get</span>; <span style="color:#a2f;font-weight:bold">set</span>;}      
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">override</span> <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#a2f;font-weight:bold">void</span> Execute()   {      
</span></span><span style="display:flex;"><span>        <span style="color:#a2f;font-weight:bold">if</span> (scoreModel.score &gt; scoreModel.highScore)         
</span></span><span style="display:flex;"><span>            socialService.PostScore(scoreModel.score);   
</span></span><span style="display:flex;"><span>    } 
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>[Inject]注入的是实现接口的类而不是特定的类,在这个例子中，我们就可以不再依赖具体的Facebook或Twitter，我们只用知道需要一个社交服务。</p>
<p>最后，我们需要将他们绑定起来</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c#" data-lang="c#"><span style="display:flex;"><span><span style="color:#080">#if UNITY_ANDROID </span>
</span></span><span style="display:flex;"><span>    injectionBinder.Bind&lt;ISocialService&gt;().To&lt;GoogleService&gt;().AsSingleton(); 
</span></span><span style="display:flex;"><span><span style="color:#080">#else </span>
</span></span><span style="display:flex;"><span>    injectionBinder.Bind&lt;ISocialService&gt;().To&lt;FacebookService().AsSingleton(); 
</span></span><span style="display:flex;"><span><span style="color:#080">#endif //...or... </span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic">//injectionBinder.Bind&lt;ISocialService&gt;().To&lt;MultiServiceResolver&gt;().AsSingleton();  </span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>injectionBinder.Bind&lt;IScoreModel&gt;().To&lt;ScoreModel&gt;().AsSingleton(); 
</span></span><span style="display:flex;"><span>commandBinder.Bind(GameEvent.SHIP_DEAD , OnShipDeathCommand); 
</span></span></code></pre></div><p>AsSingleton()的意思是，每次通过[Inject]注入ISocialService类型的对象时,获得的都是同一个GoogleService实例。</p>
<p>虽然出现了Singleton(单例),但我们不需要写一个单例模式,只用绑定它就行。</p>
<p>这样每个单元都是独立的,保证了灵活性和可维护性。</p>
    </div>

    
    
    

</section>


    </main>
    
    <footer id="footer">
    
        <div id="social">


    <a class="symbol" href="your-github-link" rel="me" target="_blank">
        
        <svg fill="#bbbbbb" width="28" height="28"  viewBox="0 0 72 72" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    
    <title>Github</title>
    <desc>Created with Sketch.</desc>
    <defs></defs>
    <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
        <g id="Social-Icons---Rounded-Black" transform="translate(-264.000000, -939.000000)">
            <g id="Github" transform="translate(264.000000, 939.000000)">
                <path d="M8,72 L64,72 C68.418278,72 72,68.418278 72,64 L72,8 C72,3.581722 68.418278,-8.11624501e-16 64,0 L8,0 C3.581722,8.11624501e-16 -5.41083001e-16,3.581722 0,8 L0,64 C5.41083001e-16,68.418278 3.581722,72 8,72 Z" id="Rounded" fill="#bbbbbb"></path>
                <path d="M35.9985,13 C22.746,13 12,23.7870921 12,37.096644 C12,47.7406712 18.876,56.7718301 28.4145,59.9584121 C29.6145,60.1797862 30.0525,59.4358488 30.0525,58.7973276 C30.0525,58.2250681 30.0315,56.7100863 30.0195,54.6996482 C23.343,56.1558981 21.9345,51.4693938 21.9345,51.4693938 C20.844,48.6864054 19.2705,47.9454799 19.2705,47.9454799 C17.091,46.4500754 19.4355,46.4801943 19.4355,46.4801943 C21.843,46.6503662 23.1105,48.9634994 23.1105,48.9634994 C25.2525,52.6455377 28.728,51.5823398 30.096,50.9649018 C30.3135,49.4077535 30.9345,48.3460615 31.62,47.7436831 C26.2905,47.1352808 20.688,45.0691228 20.688,35.8361671 C20.688,33.2052792 21.6225,31.0547881 23.1585,29.3696344 C22.911,28.7597262 22.0875,26.3110578 23.3925,22.9934585 C23.3925,22.9934585 25.4085,22.3459017 29.9925,25.4632101 C31.908,24.9285993 33.96,24.6620468 36.0015,24.6515052 C38.04,24.6620468 40.0935,24.9285993 42.0105,25.4632101 C46.5915,22.3459017 48.603,22.9934585 48.603,22.9934585 C49.9125,26.3110578 49.089,28.7597262 48.8415,29.3696344 C50.3805,31.0547881 51.309,33.2052792 51.309,35.8361671 C51.309,45.0917119 45.6975,47.1292571 40.3515,47.7256117 C41.2125,48.4695491 41.9805,49.9393525 41.9805,52.1877301 C41.9805,55.4089489 41.9505,58.0067059 41.9505,58.7973276 C41.9505,59.4418726 42.3825,60.1918338 43.6005,59.9554002 C53.13,56.7627944 60,47.7376593 60,37.096644 C60,23.7870921 49.254,13 35.9985,13" fill="#FFFFFF"></path>
            </g>
        </g>
    </g>
</svg>
    </a>


</div>

    

    <div class="copyright">
    
       © Copyright 
       2023 
       <span class="split">
        <svg fill="#bbbbbb" width="15" height="15" version="1.1" id="heart-15" xmlns="http://www.w3.org/2000/svg" width="15px" height="15px" viewBox="0 0 15 15">
  <path d="M13.91,6.75c-1.17,2.25-4.3,5.31-6.07,6.94c-0.1903,0.1718-0.4797,0.1718-0.67,0C5.39,12.06,2.26,9,1.09,6.75&#xA;&#x9;C-1.48,1.8,5-1.5,7.5,3.45C10-1.5,16.48,1.8,13.91,6.75z"/>
</svg>
       </span>
       nagisa
    
    </div>

    
</footer>



  </body>
</html>
